<div class="comment-list">
  <!-- Comment Input -->
  <div class="comment-input flex gap-3 mb-4">
    <p-avatar 
      [image]="currentUserAvatar() || undefined"
      [label]="!currentUserAvatar() ? currentUserInitials() : undefined"
      shape="circle"
    />
    <div class="flex-1">
      <textarea 
        pTextarea
        [(ngModel)]="newComment"
        [placeholder]="replyingTo() ? 'Escreva uma resposta...' : 'Escreva um comentário...'"
        [rows]="2"
        class="w-full"
        (keydown.enter)="onSubmitComment($event)"
      ></textarea>
      <div class="flex items-center justify-between mt-2">
        @if (replyingTo()) {
          <span class="text-sm text-secondary">
            Respondendo a <strong>{{ replyingTo()?.user?.name }}</strong>
            <button 
              pButton 
              type="button" 
              icon="pi pi-times" 
              class="p-button-text p-button-sm p-button-plain ml-1"
              (click)="cancelReply()"
            ></button>
          </span>
        } @else {
          <span></span>
        }
        <button 
          pButton 
          type="button"
          label="Comentar"
          icon="pi pi-send"
          [loading]="submitting()"
          [disabled]="!newComment.trim()"
          (click)="submitComment()"
          class="p-button-sm"
        ></button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading() && comments().length === 0) {
    @for (i of [1, 2, 3]; track i) {
      <div class="flex gap-3 mb-4">
        <p-skeleton shape="circle" size="2.5rem" />
        <div class="flex-1">
          <p-skeleton width="30%" height="1rem" styleClass="mb-2" />
          <p-skeleton width="100%" height="2rem" />
        </div>
      </div>
    }
  }

  <!-- Empty State -->
  @if (!loading() && comments().length === 0) {
    <div class="text-center py-8 text-secondary">
      <i class="pi pi-comments text-4xl mb-2"></i>
      <p>Nenhum comentário ainda.</p>
      <p class="text-sm">Seja o primeiro a comentar!</p>
    </div>
  }

  <!-- Comments -->
  @for (comment of comments(); track comment.id) {
    <div class="comment mb-4" [class.ml-12]="comment.parentId">
      <div class="flex gap-3">
        <a [routerLink]="['/social/profile', comment.user.username || comment.user.id]">
          <p-avatar 
            [image]="comment.user.avatar || undefined"
            [label]="!comment.user.avatar ? getInitials(comment.user.name) : undefined"
            shape="circle"
            size="normal"
          />
        </a>
        <div class="flex-1">
          <div class="bg-secondary-100 dark:bg-secondary-800 rounded-xl px-4 py-2">
            <div class="flex items-center gap-2">
              <a 
                [routerLink]="['/social/profile', comment.user.username || comment.user.id]"
                class="font-semibold text-sm hover:underline"
              >
                {{ comment.user.name }}
              </a>
              <span class="text-xs text-secondary">{{ comment.createdAt | timeAgo }}</span>
            </div>
            
            @if (editingComment()?.id === comment.id) {
              <textarea 
                pTextarea
                [(ngModel)]="editContent"
                [rows]="2"
                class="w-full mt-2"
              ></textarea>
              <div class="flex gap-2 mt-2">
                <button 
                  pButton 
                  type="button" 
                  label="Salvar" 
                  class="p-button-sm"
                  [loading]="submitting()"
                  (click)="saveEdit(comment.id)"
                ></button>
                <button 
                  pButton 
                  type="button" 
                  label="Cancelar" 
                  class="p-button-sm p-button-text"
                  (click)="cancelEdit()"
                ></button>
              </div>
            } @else {
              <p class="text-sm mt-1">{{ comment.content }}</p>
            }
          </div>

          <!-- Comment Actions -->
          @if (!editingComment() || editingComment()?.id !== comment.id) {
            <div class="flex items-center gap-3 mt-1 ml-2 text-xs">
              <button 
                class="text-secondary hover:text-primary-600 font-medium"
                (click)="onLikeComment(comment)"
              >
                {{ comment.likeCount > 0 ? comment.likeCount + ' ' : '' }}Curtir
              </button>
              <button 
                class="text-secondary hover:text-primary-600 font-medium"
                (click)="startReply(comment)"
              >
                Responder
              </button>
              @if (isOwner(comment)) {
                <button 
                  class="text-secondary hover:text-primary-600 font-medium"
                  (click)="startEdit(comment)"
                >
                  Editar
                </button>
                <button 
                  class="text-secondary hover:text-accent-600 font-medium"
                  (click)="deleteComment(comment)"
                >
                  Excluir
                </button>
              }
            </div>
          }

          <!-- Replies Count -->
          @if (comment.replyCount && comment.replyCount > 0 && !comment.replies?.length) {
            <button 
              class="text-sm text-primary-600 hover:underline mt-2 ml-2"
              (click)="loadReplies(comment)"
            >
              Ver {{ comment.replyCount }} {{ comment.replyCount === 1 ? 'resposta' : 'respostas' }}
            </button>
          }

          <!-- Replies -->
          @if (comment.replies?.length) {
            <div class="mt-3 space-y-3">
              @for (reply of comment.replies; track reply.id) {
                <div class="flex gap-3">
                  <a [routerLink]="['/social/profile', reply.user.username || reply.user.id]">
                    <p-avatar 
                      [image]="reply.user.avatar || undefined"
                      [label]="!reply.user.avatar ? getInitials(reply.user.name) : undefined"
                      shape="circle"
                      size="normal"
                    />
                  </a>
                  <div class="flex-1">
                    <div class="bg-secondary-100 dark:bg-secondary-800 rounded-xl px-4 py-2">
                      <div class="flex items-center gap-2">
                        <a 
                          [routerLink]="['/social/profile', reply.user.username || reply.user.id]"
                          class="font-semibold text-sm hover:underline"
                        >
                          {{ reply.user.name }}
                        </a>
                        <span class="text-xs text-secondary">{{ reply.createdAt | timeAgo }}</span>
                      </div>
                      <p class="text-sm mt-1">{{ reply.content }}</p>
                    </div>
                    <div class="flex items-center gap-3 mt-1 ml-2 text-xs">
                      <button 
                        class="text-secondary hover:text-primary-600 font-medium"
                        (click)="onLikeComment(reply)"
                      >
                        {{ reply.likeCount > 0 ? reply.likeCount + ' ' : '' }}Curtir
                      </button>
                      @if (isOwner(reply)) {
                        <button 
                          class="text-secondary hover:text-accent-600 font-medium"
                          (click)="deleteComment(reply)"
                        >
                          Excluir
                        </button>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- Load More -->
  @if (hasMore()) {
    <div class="text-center mt-4">
      <button 
        pButton 
        type="button"
        label="Carregar mais comentários"
        class="p-button-text"
        [loading]="loadingMore()"
        (click)="loadMore()"
      ></button>
    </div>
  }
</div>

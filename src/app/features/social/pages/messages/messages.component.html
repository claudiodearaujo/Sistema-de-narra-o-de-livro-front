<div class="messages-container">
  <div class="messages-header">
    <h1>Mensagens</h1>
    @if (totalUnread() > 0) {
      <p-badge [value]="totalUnread().toString()" severity="danger"></p-badge>
    }
    <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="secondary" class="new-message-btn" (onClick)="openNewMessageDialog()"></p-button>
  </div>
  
  <!-- Error State -->
  @if (error()) {
    <p-message severity="error" [text]="error()!" styleClass="w-full mb-3"></p-message>
    <div class="text-center">
      <p-button label="Tentar novamente" icon="pi pi-refresh" (onClick)="retry()"></p-button>
    </div>
  } @else {
    <!-- Search -->
    <div class="search-box">
      <span class="p-input-icon-left w-full">
        <i class="pi pi-search"></i>
        <input 
          type="text" 
          pInputText 
          [(ngModel)]="searchQuery"
          placeholder="Buscar conversas..." 
          class="w-full">
      </span>
    </div>

    @if (loading()) {
      <div class="conversations-skeleton">
        @for (i of [1,2,3,4]; track i) {
          <div class="conversation-skeleton">
            <p-skeleton shape="circle" size="3.5rem"></p-skeleton>
            <div class="skeleton-content">
              <p-skeleton width="60%" height="1rem"></p-skeleton>
              <p-skeleton width="80%" height="0.8rem" class="mt-2"></p-skeleton>
            </div>
            <p-skeleton width="40px" height="0.8rem"></p-skeleton>
          </div>
        }
      </div>
    } @else {
      <div class="conversations-list">
        @for (conversation of filteredConversations(); track conversation.id) {
          <a 
            [routerLink]="['/social/messages', conversation.participant.id]" 
            class="conversation-item"
            [class.unread]="conversation.unreadCount > 0">
            <div class="avatar-wrapper">
              <p-avatar 
                [image]="conversation.participant.avatar || undefined"
                [label]="conversation.participant.avatar ? undefined : conversation.participant.name.charAt(0)"
                size="large"
                shape="circle">
              </p-avatar>
              @if (isOnline(conversation.participant.id)) {
                <span class="online-indicator"></span>
              }
            </div>
            
            <div class="conversation-info">
              <div class="conversation-header">
                <span class="participant-name">{{ conversation.participant.name }}</span>
                <span class="message-time">{{ formatTimeAgo(conversation.lastMessage.createdAt) }}</span>
              </div>
              <div class="last-message">
                @if (conversation.lastMessage.senderId !== conversation.participant.id) {
                  <span class="you-label">Você: </span>
                }
                <span [class.unread-text]="conversation.unreadCount > 0">
                  {{ truncateMessage(conversation.lastMessage.content) }}
                </span>
              </div>
            </div>
            
            @if (conversation.unreadCount > 0) {
              <p-badge [value]="conversation.unreadCount.toString()" severity="info"></p-badge>
            }
          </a>
        } @empty {
          <div class="empty-state">
            @if (searchQuery()) {
              <i class="pi pi-search empty-icon"></i>
              <h3>Nenhum resultado</h3>
              <p>Não encontramos conversas com "{{ searchQuery() }}"</p>
            } @else {
              <i class="pi pi-comments empty-icon"></i>
              <h3>Nenhuma mensagem</h3>
              <p>Comece uma conversa com alguém!</p>
              <p-button label="Nova Mensagem" icon="pi pi-plus" class="mt-3" (onClick)="openNewMessageDialog()"></p-button>
            }
          </div>
        }
        
        <!-- Load More -->
        @if (hasMore() && !searchQuery()) {
          <div class="load-more">
            <p-button 
              label="Carregar mais" 
              [loading]="loadingMore()" 
              [text]="true" 
              (onClick)="loadMore()">
            </p-button>
          </div>
        }
      </div>
    }
  }
</div>

<!-- New Message Dialog -->
<p-dialog 
  header="Nova Mensagem" 
  [(visible)]="showNewMessageDialog" 
  [modal]="true" 
  [style]="{width: '400px'}"
  [draggable]="false"
  [resizable]="false">
  <div class="new-message-form">
    <div class="search-user-box">
      <span class="p-input-icon-left w-full">
        <i class="pi pi-search"></i>
        <input 
          type="text" 
          pInputText 
          [(ngModel)]="searchUserQuery"
          placeholder="Buscar usuário..." 
          class="w-full"
          (input)="searchUsers(searchUserQuery())">
      </span>
    </div>
    
    @if (searchingUsers()) {
      <div class="searching-indicator">
        <i class="pi pi-spin pi-spinner"></i>
        <span>Buscando...</span>
      </div>
    }
    
    @if (foundUsers().length > 0) {
      <div class="users-list">
        @for (user of foundUsers(); track user.id) {
          <a [routerLink]="['/social/messages', user.id]" class="user-item" (click)="closeNewMessageDialog()">
            <p-avatar 
              [image]="user.avatar || undefined"
              [label]="user.avatar ? undefined : user.name.charAt(0)"
              size="normal"
              shape="circle">
            </p-avatar>
            <div class="user-info">
              <span class="user-name">{{ user.name }}</span>
              @if (user.username) {
                <span class="user-username">&#64;{{ user.username }}</span>
              }
            </div>
          </a>
        }
      </div>
    } @else if (searchUserQuery().length >= 2 && !searchingUsers()) {
      <div class="no-users-found">
        <i class="pi pi-user-minus"></i>
        <p>Nenhum usuário encontrado</p>
      </div>
    } @else {
      <div class="search-hint">
        <p>Digite pelo menos 2 caracteres para buscar</p>
      </div>
    }
  </div>
</p-dialog>

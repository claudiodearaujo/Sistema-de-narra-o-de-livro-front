<div class="profile-container">
  @if (loading()) {
    <!-- Skeleton -->
    <div class="profile-skeleton">
      <p-skeleton width="100%" height="200px"></p-skeleton>
      <div class="profile-info-skeleton">
        <p-skeleton shape="circle" size="8rem"></p-skeleton>
        <p-skeleton width="200px" height="2rem" class="mt-3"></p-skeleton>
        <p-skeleton width="150px" height="1rem" class="mt-2"></p-skeleton>
      </div>
    </div>
  } @else if (error(); as errorMessage) {
    <!-- Error State -->
    <div class="error-container">
      <div class="error-content">
        @if (notFound()) {
          <i class="pi pi-user-minus error-icon"></i>
          <h2>Usu√°rio n√£o encontrado</h2>
          <p>O perfil que voc√™ est√° procurando n√£o existe ou foi removido.</p>
        } @else {
          <i class="pi pi-exclamation-triangle error-icon"></i>
          <h2>Ops! Algo deu errado</h2>
          <p>{{ errorMessage }}</p>
        }
        <p-button 
          label="Voltar" 
          icon="pi pi-arrow-left" 
          severity="secondary" 
          routerLink="/social/feed">
        </p-button>
      </div>
    </div>
  } @else if (profile(); as p) {
    <!-- Banner -->
    <div class="profile-banner">
      @if (p.bannerUrl) {
        <img [src]="p.bannerUrl" alt="Banner">
      }
    </div>
    
    <!-- Profile Header -->
    <div class="profile-header">
      <div class="avatar-section">
        <p-avatar 
          [image]="p.avatar || undefined"
          [label]="p.avatar ? undefined : p.name.charAt(0)"
          size="xlarge"
          shape="circle"
          styleClass="profile-avatar">
        </p-avatar>
        @if (p.isVerified) {
          <i class="pi pi-verified verified-badge" title="Verificado"></i>
        }
      </div>
      
      <div class="profile-actions">
        @if (isOwnProfile()) {
          <p-button label="Editar Perfil" severity="secondary" outlined="true" routerLink="/settings/profile"></p-button>
        } @else {
          <p-button 
            [label]="isFollowing() ? 'Seguindo' : 'Seguir'"
            [severity]="isFollowing() ? 'secondary' : 'primary'"
            [outlined]="isFollowing()"
            [loading]="loadingFollow()"
            (onClick)="toggleFollow()">
          </p-button>
          <p-button icon="pi pi-envelope" severity="secondary" outlined="true" [routerLink]="['/social/messages']"></p-button>
        }
      </div>
    </div>
    
    <!-- Profile Info -->
    <div class="profile-info">
      <h1 class="display-name">{{ p.name }}</h1>
      @if (p.username) {
        <span class="username">&#64;{{ p.username }}</span>
      }
      
      @if (p.bio) {
        <p class="bio">{{ p.bio }}</p>
      }
      
      <div class="meta-info">
        @if (p.location) {
          <span class="meta-item">
            <i class="pi pi-map-marker"></i>
            {{ p.location }}
          </span>
        }
        @if (p.website) {
          <a [href]="p.website" target="_blank" class="meta-item link">
            <i class="pi pi-link"></i>
            {{ p.website }}
          </a>
        }
        <span class="meta-item">
          <i class="pi pi-calendar"></i>
          Entrou em {{ formatDate(p.createdAt) }}
        </span>
      </div>
      
      <div class="stats">
        <button class="stat-item" (click)="openFollowers()">
          <strong>{{ formatNumber(p.stats.followers) }}</strong>
          <span>Seguidores</span>
        </button>
        <button class="stat-item" (click)="openFollowing()">
          <strong>{{ formatNumber(p.stats.following) }}</strong>
          <span>Seguindo</span>
        </button>
        <span class="stat-item">
          <strong>{{ p.stats.posts }}</strong>
          <span>Posts</span>
        </span>
        <span class="stat-item">
          <strong>{{ p.stats.books }}</strong>
          <span>Livros</span>
        </span>
      </div>
      
      <!-- Gamification (Sprint 8) -->
      @if (p.stats.level) {
        <div class="gamification-section">
          <div class="level-badge">
            <span class="level-number">{{ p.stats.level }}</span>
            <span class="level-label">N√≠vel</span>
          </div>
          <div class="xp-bar">
            <div class="xp-progress" [style.width.%]="xpProgress()"></div>
          </div>
          @if (p.stats.livraBalance !== undefined) {
            <div class="livra-balance">
              <i class="pi pi-wallet"></i>
              <span>{{ formatNumber(p.stats.livraBalance!) }} LIVRA</span>
            </div>
          }
        </div>
      }

      <!-- Achievements (Sprint 10) -->
      @if (achievements().length > 0) {
        <div class="achievements-section">
          <div class="section-header">
            <h3>üèÜ Conquistas</h3>
            <a routerLink="/achievements" class="see-all">Ver todas</a>
          </div>
          <div class="achievements-grid">
            @for (ua of achievements(); track ua.id) {
              <div class="achievement-badge" 
                   [pTooltip]="ua.achievement.name + ': ' + ua.achievement.description" 
                   tooltipPosition="top">
                <span class="achievement-icon">{{ ua.achievement.icon }}</span>
              </div>
            }
          </div>
        </div>
      }
    </div>
    
    <!-- Tabs -->
    <p-tabs value="0">
      <p-tablist>
        <p-tab value="0" (click)="onTabChange('posts')">Posts</p-tab>
        <p-tab value="1" (click)="onTabChange('books')">Livros</p-tab>
      </p-tablist>
      <p-tabpanels>
        <p-tabpanel value="0">
          <div class="posts-list">
            @for (post of posts(); track post.id) {
              <a [routerLink]="['/social/post', post.id]" class="post-item">
                <p class="post-content">{{ post.content }}</p>
                @if (post.mediaUrl) {
                  <img [src]="post.mediaUrl" alt="Post media" class="post-media">
                }
                <div class="post-stats">
                  <span><i class="pi pi-heart"></i> {{ post.likeCount }}</span>
                  <span><i class="pi pi-comment"></i> {{ post.commentCount }}</span>
                </div>
              </a>
            } @empty {
              @if (!loadingPosts()) {
                <div class="empty-posts">
                  <p>Nenhum post ainda.</p>
                </div>
              }
            }
            
            @if (loadingPosts()) {
              <div class="loading-more">
                <i class="pi pi-spin pi-spinner"></i>
                Carregando...
              </div>
            }
            
            @if (hasMorePosts() && !loadingPosts() && posts().length > 0) {
              <button class="load-more-btn" pButton label="Carregar mais" (click)="loadMorePosts()"></button>
            }
          </div>
        </p-tabpanel>
        
        <p-tabpanel value="1">
          <div class="books-list">
            @for (book of books(); track book.id) {
              <a [routerLink]="['/writer/books', book.id]" class="book-item">
                @if (book.coverUrl) {
                  <img [src]="book.coverUrl" alt="Capa" class="book-cover">
                } @else {
                  <div class="book-cover-placeholder">
                    <i class="pi pi-book"></i>
                  </div>
                }
                <div class="book-info">
                  <h3 class="book-title">{{ book.title }}</h3>
                  @if (book.genre) {
                    <span class="book-genre">{{ book.genre }}</span>
                  }
                  @if (book.description) {
                    <p class="book-description">{{ book.description }}</p>
                  }
                  <span class="book-chapters">{{ book.chapterCount }} cap√≠tulos</span>
                </div>
              </a>
            } @empty {
              @if (!loadingBooks()) {
                <div class="empty-books">
                  <i class="pi pi-book"></i>
                  <p>Nenhum livro ainda.</p>
                </div>
              }
            }
            
            @if (loadingBooks()) {
              <div class="loading-more">
                <i class="pi pi-spin pi-spinner"></i>
                Carregando...
              </div>
            }
            
            @if (hasMoreBooks() && !loadingBooks() && books().length > 0) {
              <button class="load-more-btn" pButton label="Carregar mais" (click)="loadMoreBooks()"></button>
            }
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  }
</div>

<!-- Followers Dialog -->
<p-dialog 
  header="Seguidores" 
  [visible]="showFollowersDialog()" 
  [modal]="true"
  [closable]="true"
  (visibleChange)="showFollowersDialog.set($event)"
  [style]="{width: '400px'}">
  <p>Lista de seguidores...</p>
</p-dialog>

<!-- Following Dialog -->
<p-dialog 
  header="Seguindo" 
  [visible]="showFollowingDialog()" 
  [modal]="true"
  [closable]="true"
  (visibleChange)="showFollowingDialog.set($event)"
  [style]="{width: '400px'}">
  <p>Lista de pessoas que segue...</p>
</p-dialog>

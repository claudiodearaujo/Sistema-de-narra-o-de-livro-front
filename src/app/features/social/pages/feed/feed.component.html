<div class="feed-container">
  <!-- Toast for notifications -->
  <p-toast></p-toast>
  
  <!-- Story Bar Placeholder -->
  <div class="story-bar">
    <div class="story-item your-story">
      <div class="story-avatar add">
        <i class="pi pi-plus"></i>
      </div>
      <span>Seu Story</span>
    </div>
    @for (i of storyUsers; track i) {
      <div class="story-item">
        <div class="story-avatar" [class.unviewed]="i % 2 === 0">
          <p-avatar 
            [label]="'U' + i" 
            shape="circle" 
            size="large">
          </p-avatar>
        </div>
        <span>User {{ i }}</span>
      </div>
    }
  </div>

  <!-- Post Composer -->
  <div class="post-composer">
    <p-avatar 
      shape="circle" 
      label="EU"
      size="normal">
    </p-avatar>
    <div class="composer-input" (click)="openPostModal()">
      <span>No que você está pensando?</span>
    </div>
    <button pButton class="p-button-text" icon="pi pi-image" pTooltip="Adicionar imagem"></button>
  </div>

  <!-- Error State -->
  @if (error()) {
    <div class="error-state">
      <i class="pi pi-exclamation-circle error-icon"></i>
      <p>{{ error() }}</p>
      <button pButton label="Tentar novamente" icon="pi pi-refresh" (click)="refresh()"></button>
    </div>
  }

  <!-- Loading Skeleton -->
  @if (loading() && posts().length === 0) {
    @for (i of [1, 2, 3]; track i) {
      <div class="post-skeleton">
        <div class="skeleton-header">
          <p-skeleton shape="circle" size="3rem"></p-skeleton>
          <div class="skeleton-info">
            <p-skeleton width="150px" height="1rem"></p-skeleton>
            <p-skeleton width="100px" height="0.8rem"></p-skeleton>
          </div>
        </div>
        <p-skeleton width="100%" height="4rem" styleClass="mt-3"></p-skeleton>
        <p-skeleton width="100%" height="200px" styleClass="mt-2"></p-skeleton>
        <div class="skeleton-actions mt-3">
          <p-skeleton width="60px" height="1.5rem"></p-skeleton>
          <p-skeleton width="60px" height="1.5rem"></p-skeleton>
          <p-skeleton width="60px" height="1.5rem"></p-skeleton>
        </div>
      </div>
    }
  }

  <!-- Posts -->
  @for (post of posts(); track trackByPostId($index, post)) {
    <div class="post-card">
      <div class="post-header">
        <p-avatar 
          [label]="getInitials(post.user.name)" 
          [image]="post.user.avatar || ''"
          shape="circle" 
          size="normal"
          (click)="goToProfile(post.user.username || post.user.id)">
        </p-avatar>
        <div class="post-user-info">
          <span class="user-name" (click)="goToProfile(post.user.username || post.user.id)">
            {{ post.user.name }}
          </span>
          <span class="post-time">{{ post.createdAt | timeAgo }}</span>
        </div>
        <button pButton class="p-button-text p-button-rounded" icon="pi pi-ellipsis-h"></button>
      </div>
      
      <div class="post-content">
        <p>{{ post.content }}</p>
        @if (post.mediaUrl) {
          <img [src]="post.mediaUrl" alt="Post image" class="post-image">
        }
      </div>
      
      <div class="post-stats">
        <span>{{ post.likeCount }} curtidas</span>
        <span>{{ post.commentCount }} comentários</span>
      </div>
      
      <div class="post-actions">
        <button 
          pButton 
          class="p-button-text" 
          [icon]="post.isLiked ? 'pi pi-heart-fill' : 'pi pi-heart'"
          [class.liked]="post.isLiked"
          label="Curtir"
          (click)="toggleLike(post)">
        </button>
        <button 
          pButton 
          class="p-button-text" 
          icon="pi pi-comment"
          label="Comentar"
          (click)="goToPost(post.id)">
        </button>
        <button 
          pButton 
          class="p-button-text" 
          icon="pi pi-share-alt"
          label="Compartilhar">
        </button>
      </div>
    </div>
  }

  <!-- Empty State -->
  @if (posts().length === 0 && !loading() && !error()) {
    <div class="empty-state">
      <i class="pi pi-inbox empty-icon"></i>
      <h3>Seu feed está vazio</h3>
      <p>Siga escritores para ver seus posts aqui</p>
      <button pButton label="Explorar" icon="pi pi-compass" (click)="goToExplore()"></button>
    </div>
  }

  <!-- Infinite Scroll Sentinel -->
  <div 
    appInfiniteScroll 
    (scrolled)="loadMore()"
    [disabled]="isScrollDisabled()"
    [threshold]="0.1"
    rootMargin="200px"
    class="sentinel">
  </div>

  <!-- Loading More -->
  @if (loadingMore()) {
    <div class="loading-more">
      <i class="pi pi-spin pi-spinner"></i>
      <span>Carregando mais posts...</span>
    </div>
  }
</div>

<!-- Post Composer Modal -->
<app-post-composer
  [visible]="showPostComposer()"
  [userName]="currentUser()?.name || 'Usuário'"
  [userAvatar]="currentUser()?.avatar || ''"
  (visibleChange)="showPostComposer.set($event)"
  (postCreated)="onPostCreated($event)">
</app-post-composer>

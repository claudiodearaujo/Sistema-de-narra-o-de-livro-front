<div class="p-fluid">
    <form [formGroup]="form" (ngSubmit)="save()">
        <div class="field mb-4">
            <label for="characterId"
                class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Personagem</label>
            <p-select id="characterId" [options]="characters" formControlName="characterId" optionLabel="name"
                optionValue="id" placeholder="Selecione um personagem" [filter]="true" filterBy="name"
                [showClear]="true" appendTo="body">
                <ng-template pTemplate="selectedItem" let-selectedOption>
                    <div class="flex align-items-center gap-2" *ngIf="selectedOption">
                        <div
                            class="w-6 h-6 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center text-primary-600 dark:text-primary-300 font-bold text-xs">
                            {{ selectedOption.name.charAt(0).toUpperCase() }}
                        </div>
                        <div>{{ selectedOption.name }}</div>
                    </div>
                </ng-template>
                <ng-template pTemplate="item" let-character>
                    <div class="flex align-items-center gap-2">
                        <div
                            class="w-6 h-6 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center text-primary-600 dark:text-primary-300 font-bold text-xs">
                            {{ character.name.charAt(0).toUpperCase() }}
                        </div>
                        <div>{{ character.name }}</div>
                    </div>
                </ng-template>
            </p-select>
            <small *ngIf="form.get('characterId')?.invalid && form.get('characterId')?.touched"
                class="p-error block mt-1">
                Personagem é obrigatório.
            </small>
        </div>

        <div class="ssml-guide-card mb-6">
            <button type="button" class="guide-toggle" (click)="toggleSsmlGuide()">
                <span class="pi" [ngClass]="ssmlGuideVisible ? 'pi-chevron-up' : 'pi-chevron-down'"></span>
                <span>Como usar SSML sem complicação</span>
            </button>
            <div *ngIf="ssmlGuideVisible" class="guide-body">
                <p>SSML é como um roteiro com marcações simples e os atalhos acima inserem as tags prontas para você:</p>
                <ul>
                    <li><strong>&lt;speak&gt;</strong> envolve toda a fala para evitar erros de validação.</li>
                    <li><strong>&lt;break time="500ms"/&gt;</strong> cria pausas rápidas entre frases.</li>
                    <li><strong>&lt;emphasis level="moderate"&gt;</strong> realça trechos com naturalidade.</li>
                    <li><strong>&lt;emphasis level="strong"&gt;</strong> dá destaque máximo a palavras-chave.</li>
                    <li><strong>&lt;prosody rate="slow"&gt;</strong> e <strong>&lt;prosody rate="fast"&gt;</strong> controlam o ritmo.</li>
                    <li><strong>&lt;prosody rate="slow" pitch="-2st"&gt;</strong> deixa a fala lenta e com tom grave.</li>
                    <li><strong>&lt;prosody pitch="+2st"&gt;</strong> e <strong>&lt;prosody pitch="-2st"&gt;</strong> ajustam somente o tom.</li>
                    <li><strong>&lt;say-as interpret-as="cardinal"&gt;</strong> garante que números sejam lidos como algarismos naturais.</li>
                </ul>
                <p class="prompt-hint">Dicas rápidas: teste partes pequenas, combine tags com moderação e troque o trecho específico se algo soar estranho.</p>
            </div>
        </div>
        <div class="field mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Texto / SSML</label>
            <app-ssml-editor [content]="form.get('ssmlText')?.value || form.get('text')?.value"
                (contentChange)="onSsmlChange($event)">
            </app-ssml-editor>
            <small *ngIf="form.get('text')?.invalid && form.get('text')?.touched" class="p-error block mt-1">
                Texto é obrigatório.
            </small>
        </div>

        <div class="assistant-card mb-6">
            <div class="assistant-header">
                <div>
                    <p class="assistant-eyebrow">Atalhos inteligentes</p>
                    <h3>Ferramentas para esta fala</h3>
                </div>
                <p class="assistant-helper">Aperfeiçoe o texto sem sair da tela.</p>
            </div>

            <div class="assistant-actions">
                <button pButton type="button" label="Corretor ortográfico" icon="pi pi-check-square"
                    (click)="runSpellCheck()" [loading]="spellCheckLoading"></button>
                <button pButton type="button" label="Sugestões de melhoria" icon="pi pi-lightbulb"
                    (click)="runSuggestions()" [loading]="suggestionLoading"></button>
                <button pButton type="button" label="Detalhar personagem" icon="pi pi-user-edit"
                    (click)="runCharacterEnrichment()" [disabled]="!form.get('characterId')?.value"
                    [loading]="characterEnrichmentLoading"></button>
                <button pButton type="button" label="Imagem do sentimento" icon="pi pi-image"
                    class="p-button-help" (click)="generateEmotionImage()" [loading]="emotionImageLoading"></button>
            </div>

            <div class="context-toggle">
                <label for="contextSwitch">Incluir contexto do capítulo e personagem</label>
                <p-toggleSwitch inputId="contextSwitch" name="includeContextToggle" [(ngModel)]="includeContext" [ngModelOptions]="{standalone: true}"></p-toggleSwitch>
            </div>

            <div class="assistant-result" *ngIf="spellCheckResult">
                <div class="result-header">
                    <div>
                        <h4>Correções sugeridas</h4>
                        <p>Confiança {{ spellCheckResult.confidence | percent:'1.0-0' }}</p>
                    </div>
                    <div class="result-actions">
                        <button pButton type="button" label="Aplicar" class="p-button-sm"
                            (click)="applySpellCheck()"></button>
                        <button pButton type="button" label="Descartar" class="p-button-text p-button-sm"
                            (click)="spellCheckResult = undefined"></button>
                    </div>
                </div>
                <pre>{{ spellCheckResult.correctedText }}</pre>
                <ul *ngIf="spellCheckResult.notes.length" class="result-list">
                    <li *ngFor="let note of spellCheckResult.notes">{{ note }}</li>
                </ul>
            </div>

            <div class="assistant-result" *ngIf="suggestionResult">
                <div class="result-header">
                    <div>
                        <h4>Nova proposta de fala</h4>
                        <p>{{ suggestionResult.summary }}</p>
                    </div>
                    <div class="result-actions">
                        <button pButton type="button" label="Aplicar" class="p-button-sm"
                            (click)="applySuggestion()"></button>
                        <button pButton type="button" label="Descartar" class="p-button-text p-button-sm"
                            (click)="suggestionResult = undefined"></button>
                    </div>
                </div>
                <pre>{{ suggestionResult.improvedText }}</pre>
                <ul *ngIf="suggestionResult.suggestions.length" class="result-list">
                    <li *ngFor="let tip of suggestionResult.suggestions">{{ tip }}</li>
                </ul>
            </div>

            <div class="assistant-result" *ngIf="characterEnrichmentResult">
                <div class="result-header">
                    <div>
                        <h4>Detalhes do personagem</h4>
                        <p>Conteúdo pronto para colar na fala.</p>
                    </div>
                    <div class="result-actions">
                        <button pButton type="button" label="Aplicar" class="p-button-sm"
                            (click)="applyCharacterEnrichment()"></button>
                        <button pButton type="button" label="Descartar" class="p-button-text p-button-sm"
                            (click)="characterEnrichmentResult = undefined"></button>
                    </div>
                </div>
                <pre>{{ characterEnrichmentResult.enrichedText }}</pre>
                <ul *ngIf="characterEnrichmentResult.highlights.length" class="result-list">
                    <li *ngFor="let info of characterEnrichmentResult.highlights">{{ info }}</li>
                </ul>
            </div>

            <div class="assistant-result image-result" *ngIf="emotionImageResult">
                <div class="result-header">
                    <div>
                        <h4>Visual do sentimento</h4>
                        <p>{{ emotionImageResult.caption }} ({{ emotionImageResult.sentiment }})</p>
                    </div>
                    <div class="result-actions">
                        <button pButton type="button" label="Fechar" class="p-button-text p-button-sm"
                            (click)="emotionImageResult = undefined"></button>
                    </div>
                </div>
                <img *ngIf="emotionImageDataUrl" [src]="emotionImageDataUrl" [alt]="emotionImageResult.caption">
                <small class="prompt-hint">Prompt: {{ emotionImageResult.prompt }}</small>
            </div>
        </div>


        <div class="flex justify-end gap-2">
            <button pButton type="button" label="Cancelar" class="p-button-text" (click)="cancel()"></button>
            <button pButton type="submit" label="Salvar" [disabled]="form.invalid || loading || validating"
                [loading]="loading"></button>
        </div>
    </form>
</div>